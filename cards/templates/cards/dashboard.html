{% extends "cards/base.html" %}
{% load cards_tags %}

{% block content %}
<!-- Welcome Section -->
<section class="hero is-small is-primary">
    <div class="hero-body">
        <div class="container">
            {% if not user_decks %}
                <!-- First-time user without decks -->
                <h1 class="title is-2 gowun-dodum-regular">
                    Welcome to Anishinaabe Language Cards, {{ user.profile.preferred_name|default:user.username }}!
                </h1>
                <div class="content gowun-dodum-regular">
                    <p class="subtitle">Let's get you started on your language learning journey!</p>
                    <div class="notification is-primary is-light mt-3">
                        <div class="is-flex is-align-items-center mb-2">
                            <span class="icon mr-2">
                                <i class="fas fa-lightbulb"></i>
                            </span>
                            <strong>Quick Start Guide:</strong>
                        </div>
                        <ol class="ml-5">
                            <li>Click "Add New Decks" to choose your first study deck</li>
                            <li>Learn about the <a href="{% url 'about' %}" class="has-text-primary-dark">Leitner System</a> we use for efficient learning</li>
                            <li>Start reviewing cards daily to build your streak!</li>
                        </ol>
                    </div>
                </div>
            {% elif request.session.first_login %}
                <!-- First login after adding decks -->
                <h1 class="title is-2 gowun-dodum-regular">
                    Welcome back, {{ user.profile.preferred_name|default:user.username }}!
                </h1>
                <p class="subtitle gowun-dodum-regular">
                    {% if cards_due > 0 %}
                        You have {{ cards_due }} cards waiting for review.
                    {% else %}
                        You're all caught up! Great job!
                    {% endif %}
                </p>
            {% else %}
                <!-- Regular dashboard visit -->
                <h1 class="title is-2 gowun-dodum-regular">
                    {{ user.profile.preferred_name|default:user.username }}'s Dashboard
                </h1>
                <p class="subtitle gowun-dodum-regular">
                    {% if cards_due > 0 %}
                        You have {{ cards_due }} cards waiting for review.
                    {% else %}
                        You're all caught up! Great job!
                    {% endif %}
                </p>
            {% endif %}
        </div>
    </div>
</section>

<section class="section">
    <div class="container">
        <!-- Quick Stats Row -->
        <div class="columns is-multiline">
            <!-- Today's Progress -->
            <div class="column is-4">
                <div class="box has-text-centered" title="This shows the number of reviews you have completed today.">
                    <p class="heading gowun-dodum-regular is-size-6">Today's Reviews</p>
                    <p class="title is-2 gowun-dodum-regular has-text-primary">{{ today_reviews_count }}</p>
                    <span class="icon is-large has-text-success">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </span>
                </div>
            </div>

            <!-- Study Streak -->
            <div class="column is-4">
                <div class="box has-text-centered">
                    <p class="heading gowun-dodum-regular is-size-6">Study Streak</p>
                    <p class="title is-2 gowun-dodum-regular has-text-warning">{{ user.profile.study_streak }} days</p>
                    <span class="icon is-large has-text-warning">
                        <i class="fas fa-fire fa-2x"></i>
                    </span>
                </div>
            </div>

            <!-- Cards Due Today -->
            <div class="column is-4">
                <div class="box has-text-centered">
                    <p class="heading gowun-dodum-regular is-size-6">Cards Due Today</p>
                    <p class="title is-2 gowun-dodum-regular has-text-info">{{ cards_due }}</p>
                    {% if cards_due > 0 %}
                        <a href="{% url 'study_session' first_due_deck.pk %}" 
                            class="button is-primary is-rounded is-medium mt-2 gowun-dodum-regular">
                            <span class="icon"><i class="fas fa-play"></i></span>
                            <span>Start Reviewing</span>
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Main Content Columns -->
        <div class="columns">
            <!-- Left Column: Study Progress -->
            <div class="column is-8">
                <!-- Mastery Overview -->
                <div class="box">
                    <div class="is-flex is-align-items-center mb-4">
                        <h3 class="title is-5 mb-0 mr-2">Mastery Progress</h3>
                        <a href="{% url 'about' %}" 
                            class="icon has-tooltip-right has-tooltip-multiline" 
                            data-tooltip="Learn more about the Leitner System here!">
                            <i class="fas fa-info-circle has-text-info"></i>
                        </a>
                    </div>
                    <div class="columns is-mobile">
                        {% for box, count in total_box_distribution.items %}
                        <div class="column has-text-centered">
                            <a href="{% url 'cards_in_box' box %}" class="icon has-tooltip-right has-tooltip-multiline" data-tooltip="View cards in this box.">
                                <i class="fas fa-layer-group"></i>
                            </a>
                            <p class="heading">Box {{ box }}</p>
                            <p class="title is-4">{{ count }}</p>
                            <p class="subtitle is-6">
                                {{ box_levels|get_item:box }}
                            </p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Active Decks -->
                <div class="box">
                    <h3 class="title is-5 gowun-dodum-regular mb-4">Active Decks</h3>
                    <div class="table-container">
                        <table class="table is-fullwidth is-hoverable">
                            <thead>
                                <tr>
                                    <th class="gowun-dodum-regular">Deck</th>
                                    <th class="gowun-dodum-regular">Progress</th>
                                    <th class="gowun-dodum-regular">Due</th>
                                    <th class="gowun-dodum-regular">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for deck in user_decks %}
                                <tr>
                                    <td class="gowun-dodum-regular">{{ deck.deck.name }}</td>
                                    <td style="width: 40%;">
                                        <progress class="progress is-primary is-small" 
                                                value="{{ deck.mastery_level }}" 
                                                max="100">
                                        </progress>
                                        <span class="is-size-7 gowun-dodum-regular">{{ deck.mastery_level }}%</span>
                                    </td>
                                    <td class="gowun-dodum-regular">
                                        {% if deck.due_cards > 0 %}
                                            <span class="tag is-warning">{{ deck.due_cards }}</span>
                                        {% else %}
                                            <span class="tag is-success">0</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="buttons are-small">
                                            <a href="{% url 'cards-in-deck' deck.deck.pk %}" 
                                                class="button is-primary is-rounded gowun-dodum-regular">
                                                <span class="icon"><i class="fas fa-book-open"></i></span>
                                                <span>View Cards</span>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="column is-4">
                <!-- Quick Actions -->
                <div class="box">
                    <h3 class="title is-5 gowun-dodum-regular mb-4">Quick Actions</h3>
                    <div class="buttons are-medium">
                        <a href="{% url 'deck-list' %}?filter=new" 
                            class="button is-fullwidth is-info is-outlined gowun-dodum-regular">
                            <span class="icon"><i class="fas fa-plus"></i></span>
                            <span>Add New Decks</span>
                        </a>
                        <a href="{% url 'curriculum' %}" 
                            class="button is-fullwidth is-info is-outlined gowun-dodum-regular">
                            <span class="icon"><i class="fas fa-book"></i></span>
                            <span>Modify Curriculum</span>
                        </a>
                        <a href="{% url 'profile-edit' %}" 
                            class="button is-fullwidth is-info is-outlined gowun-dodum-regular">
                            <span class="icon"><i class="fas fa-cog"></i></span>
                            <span>Settings</span>
                        </a>
                    </div>
                </div>

                <!-- Shared Decks -->
                {% if shared_decks %}
                <div class="box">
                    <h3 class="title is-5 gowun-dodum-regular mb-4">Shared Decks</h3>
                    <div class="tags are-medium">
                        {% for share in shared_decks %}
                        <span class="tag is-info is-light gowun-dodum-regular">
                            {{ share.deck.name }}
                            <span class="icon is-small ml-2">
                                {% if share.permissions == 'EDIT' %}
                                    <i class="fas fa-edit"></i>
                                {% else %}
                                    <i class="fas fa-eye"></i>
                                {% endif %}
                            </span>
                        </span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>
{% endblock %}
