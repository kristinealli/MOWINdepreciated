{% extends "cards/base.html" %}
{% load cards_tags %}

{% block content %}
<section class="hero is-small">
    <div class="hero-body" style="padding-bottom: 1.5rem;">
        <div class="container">
            <h1 class="title is-2 gowun-dodum-regular">
                Welcome, {{ user.profile.preferred_name|default:user.username }}!
            </h1>
            <p class="subtitle is-5 gowun-dodum-regular">
                Your Learning Dashboard
            </p>
        </div>
    </div>
</section>

<section class="section" style="padding-top: 1.5rem;">
    <div class="container">
        <!-- Add a new row above existing stats -->
        <div class="columns is-multiline">
            <div class="column is-6">
                <div class="box has-shadow">
                    <h3 class="title is-5 gowun-dodum-regular">Today's Progress</h3>
                    <div class="level">
                        <div class="level-item has-text-centered">
                            <div>
                                <p class="heading">Cards Reviewed</p>
                                <p class="title is-4">{{ today_reviews_count }}</p>
                            </div>
                        </div>
                        {% comment %} <div class="level-item has-text-centered">
                            <div>
                                <p class="heading">Accuracy</p>
                                <p class="title is-4">{{ today_accuracy }}%</p>
                            </div>
                        </div> {% endcomment %}
                    </div>
                </div>
            </div>
            <div class="column is-6">
                <div class="box has-shadow">
                    <h3 class="title is-5 gowun-dodum-regular">Shared With Me</h3>
                    <div class="tags">
                        {% for share in shared_decks|slice:":5" %}
                        <span class="tag is-info is-medium">
                            {{ share.deck.name }}
                            <span class="icon is-small ml-1">
                                {% if share.permissions == 'EDIT' %}
                                    <i class="fas fa-edit"></i>
                                {% else %}
                                    <i class="fas fa-eye"></i>
                                {% endif %}
                            </span>
                        </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="columns is-multiline">
            <div class="column is-3">
                <div class="box has-text-centered has-shadow">
                    <p class="heading gowun-dodum-regular">Study Streak</p>
                    <p class="title is-2">{{ user.profile.study_streak }} days</p>
                    <span class="icon has-text-warning">
                        <i class="fas fa-fire"></i>
                    </span>
                </div>
            </div>
            {% comment %} <div class="column is-3">
                <div class="box has-text-centered has-shadow">
                    <p class="heading gowun-dodum-regular">Cards Studied</p>
                    <p class="title is-2">{{ user.profile.total_cards_studied }}</p>
                    <span class="icon has-text-info">
                        <i class="fas fa-book-reader"></i>
                    </span>
                </div>
            </div> {% endcomment %}
            <div class="column is-3">
                <div class="box has-text-centered has-shadow">
                    <p class="heading gowun-dodum-regular">My Decks</p>
                    <p class="title is-2">{{ user_decks.count }}</p>
                    <span class="icon has-text-primary">
                        <i class="fas fa-layer-group"></i>
                    </span>
                </div>
            </div>
            <div class="column is-3">
                <div class="box has-text-centered has-shadow">
                    <p class="heading gowun-dodum-regular">Cards Due</p>
                    <p class="title is-2">{{ cards_due }}</p>
                    <span class="icon has-text-danger">
                        <i class="fas fa-clock"></i>
                    </span>
                </div>
            </div>
            <!-- New Leitner Box Overview -->
            <div class="column is-12">
                <div class="box has-shadow">
                    <h3 class="title is-5 gowun-dodum-regular">Leitner Box Overview</h3>
                    <div class="columns is-mobile">
                        {% for box, count in total_box_distribution.items %}
                        <div class="column has-text-centered">
                            <p class="heading gowun-dodum-regular">Box {{ box }}</p>
                            <p class="title is-4">{{ count }}</p>
                            <p class="subtitle is-6 gowun-dodum-regular">
                                {% if box == '1' %}Daily
                                {% elif box == '2' %}3 Days
                                {% elif box == '3' %}Weekly
                                {% elif box == '4' %}Biweekly
                                {% elif box == '5' %}Monthly
                                {% endif %}
                            </p>
                            <progress class="progress is-info" 
                                value="{{ count|multiply:box|to_int }}" 
                                max="{{ total_cards|multiply:5 }}">
                            </progress>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity and Study Options -->
        <div class="columns">
            <!-- Recent Decks -->
            <div class="column is-8">
                <div class="box has-shadow">
                    <h3 class="title is-4 gowun-dodum-regular">Recent Decks</h3>
                    {% if user_decks %}
                        <div class="table-container">
                            <table class="table is-fullwidth">
                                <thead>
                                    <tr>
                                        <th>Deck Name</th>
                                        <th>Progress</th>
                                        <th>Due Cards</th>
                                        <th>Mastery</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for deck in user_decks|slice:":5" %}
                                    <tr>
                                        <td colspan="5" class="is-paddingless">
                                            <div class="is-relative">
                                                <!-- Main deck row -->
                                                <div class="columns is-marginless py-2">
                                                    <div class="column">
                                                        {{ deck.deck.name }}
                                                        {% if deck.deck.is_public %}
                                                            <span class="icon has-text-info">
                                                                <i class="fas fa-globe"></i>
                                                            </span>
                                                        {% endif %}
                                                    </div>
                                                    <div class="column">
                                                        <progress class="progress is-primary is-small" 
                                                            value="{{ deck.progress }}" max="100">
                                                            {{ deck.progress }}%
                                                        </progress>
                                                    </div>
                                                    <div class="column">{{ deck.due_cards_count }}</div>
                                                    <div class="column">
                                                        <span class="tag 
                                                            {% if deck.mastery_level >= 80 %}is-success
                                                            {% elif deck.mastery_level >= 50 %}is-warning
                                                            {% else %}is-danger{% endif %}">
                                                            {{ deck.mastery_level }}%
                                                        </span>
                                                    </div>
                                                    <div class="column">
                                                        <div class="buttons are-small">
                                                            <a href="{% url 'study_session' deck_pk=deck.deck.pk %}" 
                                                                class="button is-primary is-rounded">
                                                                Study
                                                            </a>
                                                            <button class="button is-info is-rounded" 
                                                                    onclick="toggleBoxDistribution('box-dist-{{ deck.deck.pk }}')">
                                                                <span class="icon">
                                                                    <i class="fas fa-chart-bar"></i>
                                                                </span>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Leitner Box Distribution (hidden by default) -->
                                                <div id="box-dist-{{ deck.deck.pk }}" class="is-hidden box mx-4 mb-2" style="background-color: #f8f9fa;">
                                                    <h6 class="title is-6 mb-2">Leitner Box Distribution</h6>
                                                    <div class="columns is-mobile">
                                                        {% for box, count in deck.box_distribution.items %}
                                                        <div class="column has-text-centered">
                                                            <p class="heading is-size-7">Box {{ box }}</p>
                                                            <p class="title is-6 mb-1">{{ count }}</p>
                                                            <p class="is-size-7">{{ box_levels|get_item:box }}</p>
                                                        </div>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="has-text-centered gowun-dodum-regular">
                            You haven't started studying any decks yet.
                            <a href="{% url 'deck-list' %}" class="has-text-primary">Browse decks</a>
                        </p>
                    {% endif %}
                </div>
            </div>

            <!-- Replace Learning Insights with Curriculum section -->
            <div class="column is-4">
                <div class="box has-shadow mb-4">
                    <h3 class="title is-4 gowun-dodum-regular">My Curriculum</h3>
                    <div class="content">
                        {% if user.profile.chosen_decks %}
                             {% if user_decks %}
                                <div class="tags are-medium">
                                    {% for deck in user_decks|slice:":5" %}
                                        <span class="tag is-primary">
                                            {{ deck.deck.name }}
                                            <span class="icon is-small ml-1">
                                                <i class="fas fa-book"></i>
                                            </span>
                                        </span>
                                    {% endfor %}
                                </div>
                                {% if user_decks.count > 5 %}
                                    <p class="has-text-grey is-size-7">
                                        And {{ user_decks.count|add:"-5" }} more...
                                    </p>
                                {% endif %}
                            {% else %}
                                <p class="has-text-centered">
                                    No decks added to your curriculum yet.
                                </p>
                            {% endif %}
                        {% else %}
                            <p class="has-text-centered">
                                Set your curriculum target in your profile settings.
                            </p>
                        {% endif %}
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="box has-shadow">
                    <h3 class="title is-4 gowun-dodum-regular">Quick Actions</h3>
                    <div class="buttons are-medium">
                        <a href="{% url 'user-deck-list' %}" class="button is-fullwidth is-primary is-outlined mb-3">
                            <span class="icon">
                                <i class="fas fa-search"></i>
                            </span>
                            <span>Browse Decks</span>
                        </a>
                        <a href="{% url 'profile-edit' %}" class="button is-fullwidth is-info is-outlined mb-3">
                            <span class="icon">
                                <i class="fas fa-user-edit"></i>
                            </span>
                            <span>Edit Profile</span>
                        </a>
                        {% if cards_due > 0 %}
                        <a href="{% url 'study_session' first_due_deck.pk %}" class="button is-fullwidth is-success is-outlined">
                            <span class="icon">
                                <i class="fas fa-play"></i>
                            </span>
                            <span>Start Studying</span>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

{% endblock %} 

{% block extra_js %}
<script>
function toggleBoxDistribution(elementId) {
    const element = document.getElementById(elementId);
    if (element.classList.contains('is-hidden')) {
        element.classList.remove('is-hidden');
    } else {
        element.classList.add('is-hidden');
    }
}
</script>
{% endblock %}

{% block extra_css %}
<style>
.progress.is-tiny {
    height: 0.5rem;
}
</style>
{% endblock %}